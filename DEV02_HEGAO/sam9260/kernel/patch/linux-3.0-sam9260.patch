diff -uNr linux-3.0/arch/arm/mach-at91/board-sam9260ek.c linux-3.0-sam9260/arch/arm/mach-at91/board-sam9260ek.c
--- linux-3.0/arch/arm/mach-at91/board-sam9260ek.c	2011-07-22 10:17:23.000000000 +0800
+++ linux-3.0-sam9260/arch/arm/mach-at91/board-sam9260ek.c	2012-02-20 13:40:22.366298505 +0800
@@ -49,7 +49,6 @@
 #include "sam9_smc.h"
 #include "generic.h"
 
-
 static void __init ek_init_early(void)
 {
 	/* Initialize processor: 18.432 MHz crystal */
@@ -66,6 +65,12 @@
 	/* USART1 on ttyS2. (Rx, Tx, RTS, CTS) */
 	at91_register_uart(AT91SAM9260_ID_US1, 2, ATMEL_UART_CTS | ATMEL_UART_RTS);
 
+    /* Enable the rest system serial port */
+    at91_register_uart(AT91SAM9260_ID_US2, 3, ATMEL_UART_CTS | ATMEL_UART_RTS);
+    at91_register_uart(AT91SAM9260_ID_US3, 4, ATMEL_UART_CTS | ATMEL_UART_RTS);
+    at91_register_uart(AT91SAM9260_ID_US4, 5, ATMEL_UART_CTS | ATMEL_UART_RTS);
+    at91_register_uart(AT91SAM9260_ID_US5, 6, ATMEL_UART_CTS | ATMEL_UART_RTS);
+
 	/* set serial console to ttyS0 (ie, DBGU) */
 	at91_set_serial_console(0);
 }
@@ -164,19 +169,67 @@
 
 
 /*
- * NAND flash
+ * NAND flash Modify Nandflash partition
  */
 static struct mtd_partition __initdata ek_nand_partition[] = {
-	{
-		.name	= "Partition 1",
-		.offset	= 0,
-		.size	= SZ_256K,
-	},
-	{
-		.name	= "Partition 2",
-		.offset	= MTDPART_OFS_NXTBLK,
-		.size	= MTDPART_SIZ_FULL,
-	},
+#if 0 /*  Not export to Linux Kernel space, it's dangerous to do it */
+    {
+        name:"bootstrap - 128KB", /*  0x0~0x20000 */
+        offset:0,
+        size:SZ_128K
+    },
+#endif
+    {
+        name:"bootloader------256KB",   /*  0x20000~0x60000 */
+        offset:SZ_128K,
+        size:SZ_256K
+    },
+    {
+        name:"boot ENV--------128KB",   /*  0x60000~0x80000, the same as u-boot definition */
+        offset:3 * SZ_128K,
+        size:SZ_128K
+    }, 
+    {
+        name:"boot ENV BAK----128KB",   /*  0x80000~0xa0000, the same as u-boot definition */
+        offset:4 * SZ_128K,
+        size:SZ_128K
+    }, 
+    /*  Left a backup partition between u-boot and linux Kernel here */
+    {
+        name:"linux kernel----5MB",
+        offset:2 * SZ_1M, 
+        size:5 * SZ_1M
+    },
+    {
+        name:"filesystem------10MB",
+        offset:7 * SZ_1M,
+        size:10 * SZ_1M
+    },
+    {
+        name:"backup_kernel---5MB",
+        offset:17 * SZ_1M, 
+        size:5 * SZ_1M
+    },
+    {
+        name:"backup_fs-------20MB",
+        offset:22 * SZ_1M,
+        size:20 * SZ_1M
+    },
+    {
+        name:"apps------------30MB",
+        offset:42 * SZ_1M,
+        size:30 * SZ_1M
+    },
+    {
+        name:"info------------5MB",
+        offset:72 * SZ_1M,
+        size:5 * SZ_1M
+    },
+    {
+        name:"data------------51M",
+        offset:77 * SZ_1M,
+        size:51 * SZ_1M
+    },
 };
 
 static struct mtd_partition * __init nand_partitions(int size, int *num_partitions)
@@ -260,17 +313,33 @@
 /*
  * I2C devices
  */
+#if 0
 static struct at24_platform_data at24c512 = {
 	.byte_len	= SZ_512K / 8,
 	.page_size	= 128,
 	.flags		= AT24_FLAG_ADDR16,
 };
+#endif
 
 static struct i2c_board_info __initdata ek_i2c_devices[] = {
+    {
+        I2C_BOARD_INFO("rtc-ds1307", 0x68),
+        .type = "ds1307",
+    },
+    {
+        I2C_BOARD_INFO("rtc-pcf8563", 0x51),
+        .type = "pcf8563",
+    },
+    {
+        I2C_BOARD_INFO("rtc-rx8025", 0x32), /* add rtx 8025 by WENJING  */
+        .type   = "rx8025",
+    },
+#if 0
 	{
 		I2C_BOARD_INFO("24c512", 0x50),
 		.platform_data = &at24c512,
 	},
+#endif
 	/* more devices can be added using expansion connectors */
 };
 
diff -uNr linux-3.0/arch/arm/mach-at91/include/mach/at91sam9260.h linux-3.0-sam9260/arch/arm/mach-at91/include/mach/at91sam9260.h
--- linux-3.0/arch/arm/mach-at91/include/mach/at91sam9260.h	2011-07-22 10:17:23.000000000 +0800
+++ linux-3.0-sam9260/arch/arm/mach-at91/include/mach/at91sam9260.h	2012-02-20 10:45:50.608298709 +0800
@@ -76,7 +76,8 @@
 #define AT91SAM9260_BASE_TC4		0xfffdc040
 #define AT91SAM9260_BASE_TC5		0xfffdc080
 #define AT91SAM9260_BASE_ADC		0xfffe0000
-#define AT91_BASE_SYS			0xffffe800
+/* #define AT91_BASE_SYS			0xffffe800 */ /* WENJING 2011-11-25 */
+#define AT91_BASE_SYS			    0xffffc000
 
 /*
  * System Peripherals (offset from AT91_BASE_SYS)
@@ -133,4 +134,103 @@
 
 #define AT91SAM9G20_UHP_BASE	0x00500000	/* USB Host controller */
 
+/* Add by guowenxue 2011.08.01, copy from linux 2.6.22.1/include/asm/arch-at91/at91sam9260.h, for SAM card driver */
+
+/* Part I*/
+#define AT91C_US_RSTRX        (0x1 <<  2) 
+#define AT91C_US_RSTTX        (0x1 <<  3) 
+#define AT91C_US_RXEN         (0x1 <<  4) 
+#define AT91C_US_RXDIS        (0x1 <<  5) 
+#define AT91C_US_TXEN         (0x1 <<  6) 
+#define AT91C_US_TXDIS        (0x1 <<  7) 
+#define AT91C_US_RSTSTA       (0x1 <<  8) 
+
+#define AT91C_US_PAR                      (0x7 <<  9) 
+#define AT91C_US_PAR_EVEN                 (0x0 <<  9) 
+#define AT91C_US_PAR_ODD                  (0x1 <<  9) 
+#define AT91C_US_PAR_SPACE                (0x2 <<  9) 
+#define AT91C_US_PAR_MARK                 (0x3 <<  9) 
+#define AT91C_US_PAR_NONE                 (0x4 <<  9) 
+#define AT91C_US_PAR_MULTI_DROP           (0x6 <<  9) 
+#define AT91C_US_CHMODE                   (0x3 << 14) 
+#define AT91C_US_CHMODE_NORMAL            (0x0 << 14) 
+#define AT91C_US_CHMODE_AUTO              (0x1 << 14) 
+#define AT91C_US_CHMODE_LOCAL             (0x2 << 14) 
+#define AT91C_US_CHMODE_REMOTE            (0x3 << 14) 
+
+#define AT91C_US_RXRDY        (0x1 <<  0) 
+#define AT91C_US_TXRDY        (0x1 <<  1) 
+#define AT91C_US_ENDRX        (0x1 <<  3) 
+#define AT91C_US_ENDTX        (0x1 <<  4) 
+#define AT91C_US_OVRE         (0x1 <<  5) 
+#define AT91C_US_FRAME        (0x1 <<  6) 
+#define AT91C_US_PARE         (0x1 <<  7) 
+#define AT91C_US_TXEMPTY      (0x1 <<  9) 
+#define AT91C_US_TXBUFE       (0x1 << 11) 
+#define AT91C_US_RXBUFF       (0x1 << 12) 
+#define AT91C_US_COMM_TX      (0x1 << 30) 
+#define AT91C_US_COMM_RX      (0x1 << 31) 
+/* Part I End*/
+
+/* Part II*/
+#define AT91C_US_STTBRK       (0x1 <<  9) 
+#define AT91C_US_STPBRK       (0x1 << 10) 
+#define AT91C_US_STTTO        (0x1 << 11) 
+#define AT91C_US_SENDA        (0x1 << 12) 
+#define AT91C_US_RSTIT        (0x1 << 13) 
+#define AT91C_US_RSTNACK      (0x1 << 14) 
+#define AT91C_US_RETTO        (0x1 << 15) 
+#define AT91C_US_DTREN        (0x1 << 16) 
+#define AT91C_US_DTRDIS       (0x1 << 17) 
+#define AT91C_US_RTSEN        (0x1 << 18) 
+#define AT91C_US_RTSDIS       (0x1 << 19) 
+
+#define AT91C_US_USMODE       (0xF <<  0) 
+#define AT91C_US_USMODE_NORMAL             (0x0) 
+#define AT91C_US_USMODE_RS485              (0x1) 
+#define AT91C_US_USMODE_HWHSH              (0x2) 
+#define AT91C_US_USMODE_MODEM              (0x3) 
+#define AT91C_US_USMODE_ISO7816_0          (0x4) 
+#define AT91C_US_USMODE_ISO7816_1          (0x6) 
+#define AT91C_US_USMODE_IRDA               (0x8) 
+#define AT91C_US_USMODE_SWHSH              (0xC) 
+#define AT91C_US_CLKS                      (0x3 <<  4) 
+#define AT91C_US_CLKS_CLOCK                (0x0 <<  4) 
+#define AT91C_US_CLKS_FDIV1                (0x1 <<  4) 
+#define AT91C_US_CLKS_SLOW                 (0x2 <<  4) 
+#define AT91C_US_CLKS_EXT                  (0x3 <<  4) 
+#define AT91C_US_CHRL                      (0x3 <<  6) 
+#define AT91C_US_CHRL_5_BITS               (0x0 <<  6) 
+#define AT91C_US_CHRL_6_BITS               (0x1 <<  6) 
+#define AT91C_US_CHRL_7_BITS               (0x2 <<  6) 
+#define AT91C_US_CHRL_8_BITS               (0x3 <<  6) 
+#define AT91C_US_SYNC                      (0x1 <<  8) 
+#define AT91C_US_NBSTOP                    (0x3 << 12) 
+#define AT91C_US_NBSTOP_1_BIT              (0x0 << 12) 
+#define AT91C_US_NBSTOP_15_BIT             (0x1 << 12) 
+#define AT91C_US_NBSTOP_2_BIT              (0x2 << 12) 
+#define AT91C_US_MSBF         (0x1 << 16) 
+#define AT91C_US_MODE9        (0x1 << 17) 
+#define AT91C_US_CKLO         (0x1 << 18) 
+#define AT91C_US_OVER         (0x1 << 19) 
+#define AT91C_US_INACK        (0x1 << 20) 
+#define AT91C_US_DSNACK       (0x1 << 21) 
+#define AT91C_US_MAX_ITER     (0x1 << 24) 
+#define AT91C_US_FILTER       (0x1 << 28)  
+
+#define AT91C_US_RXBRK        (0x1 <<  2) 
+#define AT91C_US_TIMEOUT      (0x1 <<  8) 
+#define AT91C_US_ITERATION    (0x1 << 10) 
+#define AT91C_US_NACK         (0x1 << 13) 
+#define AT91C_US_RIIC         (0x1 << 16) 
+#define AT91C_US_DSRIC        (0x1 << 17) 
+#define AT91C_US_DCDIC        (0x1 << 18) 
+#define AT91C_US_CTSIC        (0x1 << 19) 
+
+#define AT91C_US_RI           (0x1 << 20) 
+#define AT91C_US_DSR          (0x1 << 21) 
+#define AT91C_US_DCD          (0x1 << 22) 
+#define AT91C_US_CTS          (0x1 << 23) 
+/* Part II end*/ 
+
 #endif
diff -uNr linux-3.0/drivers/tty/n_gsm.c linux-3.0-sam9260/drivers/tty/n_gsm.c
--- linux-3.0/drivers/tty/n_gsm.c	2011-07-22 10:17:23.000000000 +0800
+++ linux-3.0-sam9260/drivers/tty/n_gsm.c	2012-02-20 10:45:50.608298709 +0800
@@ -249,6 +249,7 @@
 #define MAX_MUX		4			/* 256 minors */
 static struct gsm_mux *gsm_mux[MAX_MUX];	/* GSM muxes */
 static spinlock_t gsm_mux_lock;
+static struct class *dev_class = NULL;  /* Add by guowenxue */
 
 /*
  *	This section of the driver logic implements the GSM encodings
@@ -2751,6 +2752,8 @@
 
 static int __init gsm_init(void)
 {
+    int   i, result;     /* add by guowenxue  */
+
 	/* Fill in our line protocol discipline, and register it */
 	int status = tty_register_ldisc(N_GSM0710, &tty_ldisc_packet);
 	if (status != 0) {
@@ -2787,17 +2790,47 @@
 		pr_err("gsm_init: tty registration failed.\n");
 		return -EBUSY;
 	}
+
+    /* Add by guowenxue */
+    dev_class = class_create(THIS_MODULE, gsm_tty_driver->name); 
+    if(IS_ERR(dev_class)) 
+    { 
+        printk("%s driver create class failture\n", gsm_tty_driver->name); 
+        result =  -ENOMEM; 
+        goto ERROR; 
+    }
+
+    for(i=gsm_tty_driver->minor_start; i<MAX_MUX; i++)
+    {
+        device_create(dev_class, NULL, MKDEV(gsm_tty_driver->major, i), NULL, "%s%u", gsm_tty_driver->name, i);
+    }
+    /* Add by guowenxue end */
+
 	pr_debug("gsm_init: loaded as %d,%d.\n",
 			gsm_tty_driver->major, gsm_tty_driver->minor_start);
 	return 0;
+
+ERROR:
+    tty_unregister_driver(gsm_tty_driver);
+    put_tty_driver(gsm_tty_driver);
+    return result;
 }
 
 static void __exit gsm_exit(void)
 {
 	int status = tty_unregister_ldisc(N_GSM0710);
+    int i;
 	if (status != 0)
 		pr_err("n_gsm: can't unregister line discipline (err = %d)\n",
 								status);
+    /* Add by guowenxue  */
+    for(i=gsm_tty_driver->minor_start; i<MAX_MUX; i++)
+    {
+        device_destroy(dev_class, MKDEV(gsm_tty_driver->major, i));
+    }
+    class_destroy(dev_class);
+    /* Add end */
+
 	tty_unregister_driver(gsm_tty_driver);
 	put_tty_driver(gsm_tty_driver);
 }
diff -uNr linux-3.0/Makefile linux-3.0-sam9260/Makefile
--- linux-3.0/Makefile	2011-07-22 10:17:23.000000000 +0800
+++ linux-3.0-sam9260/Makefile	2012-02-20 10:45:50.609535406 +0800
@@ -144,9 +144,10 @@
 # but instead _all depend on modules
 PHONY += all
 ifeq ($(KBUILD_EXTMOD),)
-_all: all
+#Add UIMAGE target by guowenxue
+_all: all UIMAGE   
 else
-_all: modules
+_all: modules UIMAGE
 endif
 
 srctree		:= $(if $(KBUILD_SRC),$(KBUILD_SRC),$(CURDIR))
@@ -192,8 +193,9 @@
 # Default value for CROSS_COMPILE is not to prefix executables
 # Note: Some architectures assign CROSS_COMPILE in their arch/*/Makefile
 export KBUILD_BUILDHOST := $(SUBARCH)
-ARCH		?= $(SUBARCH)
-CROSS_COMPILE	?= $(CONFIG_CROSS_COMPILE:"%"=%)
+#Modify by guowenxue
+ARCH		?= arm
+CROSS_COMPILE	?= /opt/buildroot-2011.02/arm926t/usr/bin/arm-linux-
 
 # Architecture as present in compile.h
 UTS_MACHINE 	:= $(ARCH)
@@ -1080,6 +1082,11 @@
 
 all: modules
 
+UIMAGE: 
+	cp arch/arm/boot/zImage . -f 
+	mkimage -A arm -O linux -n AT91SAM9260 -C NONE -a 0x20008000 -e 0x20008000 -d zImage uImage.gz 
+	rm -f zImage
+
 #	Build modules
 #
 #	A module can be listed more than once in obj-m resulting in
@@ -1409,6 +1416,7 @@
 		-o -name '*.symtypes' -o -name 'modules.order' \
 		-o -name modules.builtin -o -name '.tmp_*.o.*' \
 		-o -name '*.gcno' \) -type f -print | xargs rm -f
+	@rm -f uImage.gz  #Modify by guowenxue
 
 # Generate tags for editors
 # ---------------------------------------------------------------------------
diff -uNr linux-3.0/scripts/mkcompile_h linux-3.0-sam9260/scripts/mkcompile_h
--- linux-3.0/scripts/mkcompile_h	2011-07-22 10:17:23.000000000 +0800
+++ linux-3.0-sam9260/scripts/mkcompile_h	2012-02-20 10:45:50.609535406 +0800
@@ -26,17 +26,27 @@
 LC_ALL=C
 export LC_ALL
 
+# Here support old svn cline version which each svn folder has file named entries, add by WENJING Thu Jan 19 12:56:39 CST 2012
 if [ -z "$KBUILD_BUILD_VERSION" ]; then
-	if [ -r .version ]; then
-		VERSION=`cat .version`
-	else
-		VERSION=0
-		echo 0 > .version
-	fi
+    if [ -r ../patch/.svn/entries ]; then
+        VERSION=`sed -n -e 11p ../patch/.svn/entries`
+        echo $VERSION > .version
+    else
+        VERSION=0
+        echo 0 > .version
+    fi
 else
-	VERSION=$KBUILD_BUILD_VERSION
+    VERSION=$KBUILD_BUILD_VERSION
 fi
 
+#add by luyijie for svn>=1.7
+#---------------------------
+set +f
+#svnrev ../*  # Seems cannot work cuz kernel source folder out of svn control, so comment here by WENJING
+VERSION=SVN`sed -n /SVN_REVSTR/p ../svnrev.h | awk -F '"' '{print $2}'`
+echo ---- $VERSION ----
+#--------------------------
+
 if [ -z "$KBUILD_BUILD_TIMESTAMP" ]; then
 	TIMESTAMP=`date`
 else
@@ -53,7 +63,7 @@
 	LINUX_COMPILE_HOST=$KBUILD_BUILD_HOST
 fi
 
-UTS_VERSION="#$VERSION"
+UTS_VERSION="$VERSION"
 CONFIG_FLAGS=""
 if [ -n "$SMP" ] ; then CONFIG_FLAGS="SMP"; fi
 if [ -n "$PREEMPT" ] ; then CONFIG_FLAGS="$CONFIG_FLAGS PREEMPT"; fi
